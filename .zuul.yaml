# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

- project:
    templates:
      - docs-on-readthedocs
    check:
      jobs:
        - airship-deckhand-tox-py27-postgresql
        - airship-deckhand-tox-py35-postgresql
        - airship-deckhand-functional-uwsgi-py35:
            voting: false
        - airship-deckhand-functional-docker-py35
        - airship-deckhand-integration-uwsgi-py35:
            voting: false
        - airship-deckhand-integration-docker-py35
        - airship-deckhand-docker-build-gate
    gate:
      jobs:
        - airship-deckhand-tox-py27-postgresql
        - airship-deckhand-tox-py35-postgresql
        - airship-deckhand-functional-docker-py35
        - airship-deckhand-integration-docker-py35
        - airship-deckhand-docker-build-gate
    post:
      jobs:
        - airship-deckhand-doc-publish
        - airship-deckhand-docker-publish

- nodeset:
    name: airship-deckhand-single-node
    nodes:
      - name: primary
        label: ubuntu-xenial

- job:
    name: airship-deckhand-tox-py27-postgresql
    parent: openstack-tox-py27
    pre-run:
      - tools/gate/playbooks/install-postgresql.yaml
    vars:
      tox_envlist: py27-postgresql

- job:
    name: airship-deckhand-tox-py35-postgresql
    parent: openstack-tox-py35
    pre-run:
      - tools/gate/playbooks/install-postgresql.yaml
    vars:
      tox_envlist: py35-postgresql

- job:
    name: airship-deckhand-functional-uwsgi-py35
    description: |
      Run tox-based functional tests for the Airship Deckhand project using a
      minimalistic deployment consisting of uwsgi for Deckhand API and pifpaf
      for ephemeral PostgreSQL DB, under cPython version 3.5.
    run: tools/gate/playbooks/run-functional-tests-uwsgi.yaml
    nodeset: openstack-helm-single-node
    vars:
      tox_envlist: functional-dev
    irrelevant-files:
      - ^.*\.rst$
      - ^doc/.*$
      - ^etc/.*$
      - ^releasenotes/.*$
      - ^setup.cfg$
      - ^deckhand/tests/unit/.*$

- job:
    name: airship-deckhand-functional-docker-base
    description: |
      Base job for running airship-deckhand functional tests. Runs tests
      against Docker image generated from source code.
    roles:
      - zuul: openstack/openstack-helm-infra
    timeout: 3600
    pre-run:
      - tools/gate/playbooks/osh-infra-upgrade-host.yaml
      - tools/gate/playbooks/osh-infra-deploy-docker.yaml
    run: tools/gate/playbooks/run-functional-tests-docker.yaml
    required-projects:
      - openstack/openstack-helm-infra

- job:
    name: airship-deckhand-functional-docker-py35
    description: |
      Run tox-based functional tests for the Airship Deckhand project under
      cPython version 3.5. Uses tox with the ``functional-py35`` environment.
    parent: airship-deckhand-functional-docker-base
    nodeset: openstack-helm-single-node
    vars:
      tox_envlist: functional
      disable_keystone: true
    irrelevant-files:
      - ^.*\.rst$
      - ^doc/.*$
      - ^etc/.*$
      - ^releasenotes/.*$
      - ^setup.cfg$
      - ^deckhand/tests/unit/.*$

- job:
    name: airship-deckhand-integration-uwsgi-py35
    description: |
      Run tox-based integration tests for the Airship Deckhand project using a
      minimalistic deployment consisting of uwsgi for Deckhand API and pifpaf
      for ephemeral PostgreSQL DB, under cPython version 3.5.
    timeout: 3600
    run: tools/gate/playbooks/run-integration-tests-uwsgi.yaml
    nodeset: openstack-helm-single-node
    irrelevant-files:
      - ^.*\.rst$
      - ^doc/.*$
      - ^etc/.*$
      - ^releasenotes/.*$
      - ^setup.cfg$
      - ^deckhand/tests/unit/.*$
    vars:
      disable_keystone: true

- job:
    name: airship-deckhand-integration-docker-base
    description: |
      Base job for running airship-deckhand integration tests. Runs tests
      against Docker image generated from source code.
    timeout: 3600
    roles:
      - zuul: openstack/openstack-helm-infra
    vars:
      zuul_osh_relative_path: ../openstack-helm/
      zuul_osh_infra_relative_path: ../openstack-helm-infra/
    pre-run:
      - tools/gate/playbooks/osh-infra-upgrade-host.yaml
      - tools/gate/playbooks/osh-infra-deploy-docker.yaml
    run: tools/gate/playbooks/run-integration-tests-docker.yaml
    post-run: tools/gate/playbooks/osh-infra-collect-logs.yaml
    required-projects:
      - openstack/openstack-helm
      - openstack/openstack-helm-infra
    irrelevant-files:
      - ^.*\.rst$
      - ^doc/.*$
      - ^releasenotes/.*$

- job:
    name: airship-deckhand-integration-docker-py35
    description: |
      Run tox-based integration tests for the Airship Deckhand project under
      cPython version 3.5.
    parent: airship-deckhand-integration-docker-base
    nodeset: openstack-helm-single-node
    vars:
      disable_keystone: false

- job:
    name: airship-deckhand-docker-build-gate
    timeout: 1800
    run: tools/gate/playbooks/docker-image-build.yaml
    nodeset: airship-deckhand-single-node
    irrelevant-files:
      - ^.*\.rst$
      - ^doc/.*$
      - ^charts/.*$
      - ^etc/.*$
      - ^releasenotes/.*$
      - ^setup.cfg$
    vars:
      publish: false
      tags:
        dynamic:
          patch_set: true

- job:
    name: airship-deckhand-docker-publish
    timeout: 1800
    run: tools/gate/playbooks/docker-image-build.yaml
    nodeset: airship-deckhand-single-node
    secrets:
      - airship_deckhand_quay_creds
    irrelevant-files:
      - ^.*\.rst$
      - ^doc/.*$
      - ^charts/.*$
      - ^etc/.*$
      - ^releasenotes/.*$
      - ^setup.cfg$
    vars:
      publish: true
      tags:
        dynamic:
          branch: true
          commit: true
        static:
          - latest

- job:
    name: airship-deckhand-doc-publish
    description: |
      Publish documentation on airship-deckhand.readthedocs.io.
    timeout: 300
    run: tools/gate/playbooks/rtd-build-trigger.yaml
    nodeset: airship-deckhand-single-node
    secrets:
      - deckhand_rtd_credential

- secret:
    name: deckhand_rtd_credential
    data:
      token: !encrypted/pkcs1-oaep
        - ptw5Bg0LRV1LYhiv1Cqxphq3UZGYqNI7GVeTJBy5NiidvMRMk/Fvd1lDRevp52scwSHNy
          1jDUR+XolBaiHgySQbaDneuFr0oFyU72VZLBg53xe7U5aQfPzAdDx6teIly1hWpPmTNal
          SEQGtF05Nv6PniM4IS9VPHsaRJjiP14t8CpUAwIO/YZWWmSzZo2qeMAGXOXUwGmiR23R8
          rmlLUXxyMm1v+B/CszfIfSloy3kqB/PuUmoPTC/UdZMVWYv4vJT6SErsc24m0fixXJVwd
          3ysJv1fOisZYpJaY68a1CghuSza2OZngZNQ5iro1DW5mKcpuEhBbF2tJzuUnvjT635FZZ
          TuaKFfinmxYa5sMg7fxwfzdJEkMslQKbthJe5nNouBazKEppanIytld+6xSbJw/B1OvJt
          6vjF8vb42PQSnzLwQXBQmryE6QM22ky2C3ublhuA/Bd/oJHiA7m2r+svTzBMTXfV8pLtj
          rEjofiAZ0BlieNy/2m0c/KnIuv9rxVYxWdFSR36NJ0EcpKGnvdcnXbi4ko+QcEuDuAnUi
          eCrX0VDoz4F7WlBUPbc4lujD364AGnoxwsGOinjLExsM0oWiDYG0E5SNXrOVzht9a90qV
          8UT24WwKzSiwCBOcWzD0zY0ifxvmb3oQKIjZQiSh8kPXHv9ljP3oW9NVWltwzo=
      id: !encrypted/pkcs1-oaep
        - OpmuFRUcuoFd7C8soC4ExkJq1K6uo9FQFc5Nw3TBqR70iCYZQs+r4+TyV8/L1L6sddKBl
          NlV9wQg7RzSZgEzYvzNr3xTyKjxJYdiCbB6YpK/Du7aW5wvOrxhjP6m2+PdbpsGPNkYio
          YvFgiZuRqt0qQwUp46MJo11rf09ReboDbpDUUdon6E53mbc0V6VUmW9t02zWGuPqmnpS1
          3NPtCNgZi3Ie6/9AYlSsxpQHWUqcTo2K0XSHHan4MKAVewveATwsEYg2Rs07ud4qeVpsS
          /YVoWAf4cnn1eDJeUzUAlQGBILbKspOXM9jqg95xm57Plh0cYPeQ/fEhB4tYeaHL+g3Nx
          0wfmeE7+LsCLIC2Wg+p90WWnh0jV7kwNfAy3j5cDukbDIdptHm+b+yzCc5phwY5io4KFY
          POmdd3Si2V99d/wc3oXnqCmal8XmLruKd8Qq100ErJhPJQ0VeO9TM9MxenKAavMjYnX2m
          ioXsLnq6c3bhVxDg3gOmqWrPtPe3VkHnN3hptYr79QKGg65VNCasrc6Y88IGH/nOQSKaB
          KaJ9sAH4+80U7nvaK6KDOb+8Kvl4qavSSNwtQaSyeYdkviibTuO40Qpg4PO3KHqYq1VEb
          SMfJSw4+n+aTdU/o4nQlmivTuN9D5MQY/7Bklw/Dro1R1nw0AjugBz0ZEmMFoQ=

- secret:
    name: airship_deckhand_quay_creds
    data:
      username: !encrypted/pkcs1-oaep
        - eC+ZaBS1TN37yuvL2WoGkJQ8OFBSLiXxV0wAkH+2l9wLNjmT3QxwnjXTNSw883zEkE9C/
          XPDUxgv7RMLO/Bfs7uXKH1QjCbIJREPJ7Vk6WY9BUvn6olT/JCafpRcsmAkIS4W8p0l7J
          ZxelQnGm/Z2zcq4eWeKzKsFLGiAHyoFASXqlDf93NesR+lZ4xnZkO24+oPMpZq6o2Xr2D
          eWrxEcEsn817o7bA5d9mHb3u2e4tgyxhRevz43VD+0p1bK1thjRnUVpmOvHNjGI+jphAT
          Vf2+Zqys0+xJ4yJ62bhnayvLZeaKD96rLIXCsbm4xYWsyrzCYvJQ4nESY7McYoDEG6PgL
          3Gr/6oyNUzobQNAxuwo0GpecaBVy5Z1/8Ihlb8r1nNM3J0a7oz1PyPS4O7WRlQmXgHJ/x
          jJJmh66ruDxi1bcarmn4AR6lWmfyFqHwIlptsvX9AcJd4FWII9ZYdTUiidJ9ob4KmchIY
          G0wdqGDaekNR01VgB+JD05IM4UMLjwRnFmLUKIvo0H9YU5X253rv/GXNks1Ov2OevIlch
          RnnnpCESNso+xup0IztfWBkcGPGBpgmIh6T5s5bfg0n9CYEzsJMGiJuMKgeZcBvnif6Qb
          y1mzFxQiyEUUPzngF6ger7sBdXSrkCv8cqWsxdeVf2xEXLCDl/x2rhfj7fa5C8=
      password: !encrypted/pkcs1-oaep
        - TL/cjk3UCv2QQTk/QX6ujvLpHQDgijFmBWG3r9Hg/migT1Iry/eQi/HftHhShWjF0lk6Y
          kesdX49H8wXHkRutGxrmcb4HMde4clebtT0dIvVFU7/Ieoq5OnxVLdIPP3YBLZYLy5Ah5
          jLtfV1FJsuRN5gVGJeOXQUhPitrEnNrcj50ke1+llvfRl7PIR1byAM/6gQLbV3oUtOgk6
          jmpieqxq55yO+o76bXOp8YNNVr0eqI1nISfBoku2GL7nipAcfxDIeR3a5J4pdaJEEhJR7
          qqgp1RMt/aADkBUDqw1xbF86V2Mh2l60mWtYUHm4EvOFotrzeOd6Th73K9y57cBuQRJwT
          qP+T+3yuTtuwvzjgTG+h5deppsRb3EFtPYSI6TqWVKtH2zwRbTJCSbgdY03Tjrwn9vZJK
          QA4O1fRLBhchBqaIcpOFj8AFNPYCtz6cvL0uzAHXfQoQ3r9icNlPg0N5W2VINxYvDIiOc
          Lfpty/EyKOJJpOXoBiJlsGHFLi/8gdMAAtMDf72yrQH6KxdNxdRGs5oALkUQ1IcuLbXng
          ySP8WG+DBiwjt4IAtwd/sF+jyVBzDaywxdbS6RJycI+lRThvibQ5UFpr349yOhUdETB6p
          yzFswIVmx1tHM7NhD80zwdSEj4EjG0AL3GXuwfLHGbr5WIeCaVEuCMW+XUwQpw=
