# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

- project:
    templates:
      - docs-on-readthedocs
    vars:
      rtd_webhook_id: '38572'
      rtd_project_name: 'airship-deckhand'
    check:
      jobs:
        - openstack-tox-py312
        - deckhand-tox-py312-postgresql
        - deckhand-functional-uwsgi-py312
        - deckhand-functional-docker-py312
        - deckhand-integration-uwsgi-gabbi
        - deckhand-integration-docker-gabbi
        - deckhand-chart-build-gate
        - deckhand-chart-build-latest-htk
        - deckhand-docker-build-gate
        - deckhand-openstack-tox-pep8-noble
        - deckhand-openstack-tox-cover-noble
        - deckhand-airskiff-deployment-noble-kubeadm

    gate:
      jobs:
        - openstack-tox-py312
        - deckhand-tox-py312-postgresql
        - deckhand-functional-uwsgi-py312
        - deckhand-functional-docker-py312
        - deckhand-integration-uwsgi-gabbi
        - deckhand-integration-docker-gabbi
        - deckhand-chart-build-gate
        - deckhand-chart-build-latest-htk
        - deckhand-docker-build-gate
        - deckhand-openstack-tox-pep8-noble
        - deckhand-openstack-tox-cover-noble


    post:
      jobs:
        - deckhand-upload-git-mirror
        - deckhand-docker-publish-ubuntu_noble

- nodeset:
    name: deckhand-single-node-noble
    nodes:
      - name: primary
        label: ubuntu-noble

- nodeset:
    name: deckhand-single-node-jammy
    nodes:
      - name: primary
        label: ubuntu-jammy

- job:
    name: deckhand-openstack-tox-pep8-noble
    parent: openstack-tox-pep8
    description: Runs pep8 job on noble
    nodeset: treasuremap-airskiff-1node-ubuntu_noble

- job:
    name: deckhand-openstack-tox-cover-noble
    parent: openstack-tox-cover
    description: Runs cover job on noble
    nodeset: treasuremap-airskiff-1node-ubuntu_noble

- job:
    name: deckhand-tox-py312-postgresql
    nodeset: treasuremap-airskiff-1node-ubuntu_noble
    parent: treasuremap-airskiff-infra-deploy-base
    required-projects:
      - name: airship/treasuremap
        override-checkout: v1.9
    roles:
      - zuul: airship/treasuremap
    run:
      - tools/gate/playbooks/run-tox-tests.yaml
    vars:
      tox_envlist: py312-postgresql
    irrelevant-files: &irrelevant-files
      - ^.*\.rst$
      - ^doc/.*$
      - ^etc/.*$
      - ^releasenotes/.*$
      - ^setup.cfg$
      - ^deckhand/tests/unit/.*$


- job:
    name: deckhand-functional-docker-py312
    description: |
      Run tox-based functional tests for the Airship Deckhand project under
      cPython version 3.12. Uses tox with the ``functional-py312`` environment.
      Ubuntu (noble) image is built and used.
    nodeset: treasuremap-airskiff-1node-ubuntu_noble
    parent: treasuremap-airskiff-infra-deploy-base
    required-projects:
      - name: airship/treasuremap
        override-checkout: v1.9
    roles:
      - zuul: airship/treasuremap
    run:
      - tools/gate/playbooks/run-functional-tests-docker.yaml
    vars:
      tox_envlist: py312-functional
      disable_keystone: true
      DISTRO: ubuntu_noble
    irrelevant-files: *irrelevant-files

- job:
    name: deckhand-functional-uwsgi-py312
    description: |
      Run tox-based functional tests for the Airship Deckhand project using a
      minimalistic deployment consisting of uwsgi for Deckhand API and pifpaf
      for ephemeral PostgreSQL DB, under cPython version 3.12.
    nodeset: treasuremap-airskiff-1node-ubuntu_noble
    parent: treasuremap-airskiff-infra-deploy-base
    required-projects:
      - name: airship/treasuremap
        override-checkout: v1.9
    roles:
      - zuul: airship/treasuremap
    run:
      - tools/gate/playbooks/run-functional-tests-uwsgi.yaml
    vars:
      tox_envlist: py312-functional-dev
      DISTRO: ubuntu_noble
    irrelevant-files: *irrelevant-files

- job:
    name: deckhand-integration-base
    description: |
      Run integration tests for the Airship Deckhand project
    abstract: true
    parent: treasuremap-airskiff-infra-deploy-base
    required-projects:
      - name: airship/treasuremap
        override-checkout: v1.9
    roles:
      - zuul: airship/treasuremap
    vars:
      treasuremap_ref: v1.9
      osh_params:
        openstack_release: "2025.2"
        container_distro_name: ubuntu
        container_distro_version: noble
      osh_values_overrides_path: ../../openstack/openstack-helm
      gate_scripts_relative_path: ../../openstack/openstack-helm
      gate_scripts:
        - ./tools/deployment/common/prepare-k8s.sh
        - ./tools/deployment/common/prepare-charts.sh
        - ./tools/deployment/common/setup-client.sh
        - ./tools/deployment/ceph/ceph-rook.sh
        - ./tools/deployment/ceph/ceph-adapter-rook.sh
        - ./tools/deployment/db/mariadb.sh
        - ./tools/deployment/component/common/memcached.sh
        - ./tools/deployment/component/common/rabbitmq.sh
        - ./tools/deployment/component/keystone/keystone.sh
        - ./tools/deployment/component/barbican/barbican.sh
    irrelevant-files: *irrelevant-files

- job:
    name: deckhand-integration-uwsgi-gabbi
    description: |
      Run gabbi-based integration tests for the Airship Deckhand project using a
      minimalistic deployment consisting of uwsgi for Deckhand API and pifpaf
      for ephemeral PostgreSQL DB, under cPython version 3.12.
    nodeset: treasuremap-airskiff-5nodes-ubuntu_noble
    parent: deckhand-integration-base
    run:
      - tools/gate/playbooks/airship-run-scripts.yaml
      - tools/gate/playbooks/run-integration-tests-uwsgi.yaml
    vars:
      disable_keystone: true

- job:
    name: deckhand-integration-docker-gabbi
    description: |
      Run gabbi-based integration tests for the Airship Deckhand project under
      cPython version 3.12. Builds ubuntu (noble) deckhand image.
    nodeset: treasuremap-airskiff-5nodes-ubuntu_noble
    parent: deckhand-integration-base
    run:
      - tools/gate/playbooks/airship-run-scripts.yaml
      - tools/gate/playbooks/run-integration-tests-docker.yaml
    vars:
      disable_keystone: false
      DISTRO: ubuntu_noble

- job:
    name: deckhand-chart-build-gate
    description: |
      Build charts using pinned Helm toolkit.
    timeout: 900
    run: tools/gate/playbooks/build-charts.yaml
    nodeset: deckhand-single-node-noble
    vars:
      HTK_COMMIT: c1be7b83ff530b2aa39bb81e9ac35f8155266123

- job:
    name: deckhand-chart-build-latest-htk
    description: |
      Build charts using latest Helm toolkit.
    timeout: 900
    run: tools/gate/playbooks/build-charts.yaml
    nodeset: deckhand-single-node-noble
    vars:
      HTK_COMMIT: master


- job:
    name: deckhand-airskiff-deployment-noble-kubeadm
    description: |
      Deploy Memcached using Airskiff and submitted Deckhand changes.
    parent: treasuremap-airskiff-infra-deploy-base
    nodeset: treasuremap-airskiff-1node-ubuntu_noble
    required-projects:
      - name: airship/treasuremap
        override-checkout: v1.9
    roles:
      - zuul: airship/treasuremap
    vars:
      CLONE_DECKHAND: false
      MAKE_DECKHAND_IMAGES: true
      USE_ARMADA_GO: true
      DISTRO: ubuntu_noble
      DOCKER_REGISTRY: localhost:5000
      gate_scripts_relative_path: ../../airship/treasuremap

- job:
    name: deckhand-docker-build-gate
    timeout: 3600
    run: tools/gate/playbooks/docker-image-build.yaml
    nodeset: treasuremap-airskiff-1node-ubuntu_noble
    irrelevant-files: &non-code-files-template
      - ^.*\.rst$
      - ^doc/.*$
      - ^charts/.*$
      - ^etc/.*$
      - ^releasenotes/.*$
      - ^setup.cfg$
    vars:
      publish: false
      distro: ubuntu_noble
      tags:
        dynamic:
          patch_set: true

- job:
    name: deckhand-docker-publish-ubuntu_noble
    description: |
      Runs on every merge, unless files in a dictionary below are changed.
      Builds and publishes container ubuntu images on quay.io with a set of tags
      listed in vars section. Waits in Zuul queue for a node (VM) assignment.
    timeout: 3600
    run: tools/gate/playbooks/docker-image-build.yaml
    nodeset: treasuremap-airskiff-1node-ubuntu_noble
    secrets:
      - airship_deckhand_quay_creds_2026
    irrelevant-files: *non-code-files-template
    vars:
      publish: true
      distro: ubuntu_noble
      tags:
        dynamic:
          branch: true
          commit: true
        static:
          - latest
          - airflow_3.1.5

- secret:
    name: airship_deckhand_quay_creds_2026
    data:
      username: !encrypted/pkcs1-oaep
        - oAiaCHuAuXq4UhXlNv9nxeyCQLYP17uRF3C2X48sTE+d1SH8ODXKCJ9LeDnbmJsAevmfU
          F68oU8ScERQSekZw6beD2MNag5zmwHScL+PRZnVyWimZVIirVS7j/l/YWMPPdbXUw1TgL
          d/jnk/1I2qYUxrvKYg2GZwGIPflIiWW2T9t8adK+ACGk98uOroC7YICUMvXEeP/5LAw3P
          7f/yD5tpYuHpr8I1Y8WBJH5aI/oai6AbrVcVKpTklGGXWkuNfc64Z1NOzX3HZE1vMQRRi
          soEeGWmDKH5P//ZEsSoIALjzvvVNkG2txO+vdmiltMsljwTKPe+IhgD0IxjdEnBduUmpK
          JwIChO0KRx/rkEmRt63RfW27QoZjIVJ8McyBxuq1E5ehY78w5s4lWTIokQ6L0Ie0upGYc
          SFu5uZ9JMTUfNv5ULi/nwHhvsq5bAyNV7RyTmIA/RjYw/umgcJx70RMRsLEQMp2q05D/+
          mKg7nW3UKI3ENRGWgSGyofSDfOzRRoIMBDzyI0NPs75Kb7D4YpoeplWpS5BefwL6eT4Fe
          aKBcmvTxLvy3+5i+Hxg5e+teofO0LQOERE3fDHA+IissVidHieoaMMCY6pSdaoUfXVxuP
          5aPaNAc/e+p4+vzPKlNdGomsUpgJeYZ6/fDonTfBky/kKqS2y/w9mBdR5yk1r0=
      password: !encrypted/pkcs1-oaep
        - Bj0yi4T+JARjP3xTpxOQIPsYsRataAAB4M6b1Smxy9kGJ5zFnP7X+X81xAA8hQ8VuX40X
          x+KFx+npaArsie5U6DYKS//yzyYBnuigHd53T1dId2kpWztk+b9EXrRSb3jwvUi8qiaw9
          Uxf4IUjr+tt0WqoNMHI+Id1Wp1N3BDzgEdk4RwfOWq+yd+suqtoYuc6kfOz4g9q3ZSKRh
          xki8H27S0FRkLfbGliZZRRzg9vdMGntoQY+O04jLLd5yqhmpYIBmWgsqhFctP+SpLPn/d
          xvWVDF0LNFTLbVLl01N9yNGsvQ2T6ElpgYj5nQ3wdb+OfmVvXta+wW6h4anBAmAvhem31
          /LMzvyRiSvpuL8poPUmuEk1amb4zFNApkp5yf1xyAxk07qgLmkXxqye8TKEBtDnNhz44d
          RuJRuIZ3Y6rYWODNqYpc5Lkrx8Ba2/CWN/1RobUTxJntr0FGPuVuWjPBBbZ4FXBbiHUGo
          7oOueYwiF1Jh/YBfuFFkxTusk8cDFa/6pXB+7Cx5MGhupW+/UH4xV66wkcJJ/JZkcLe3G
          tmrd712WfM5yFNRDJAhtQDd8OZGZk7PcYsOzfnL3NoOoHQT44XSMERVahLrTkcTQcdkNJ
          YYqEyoL1aqHrloksH4o4nv9uqEh4PnOCP4ZGldtlApqnxNjlxndkS6cWUtpcik=


- job:
    name: deckhand-upload-git-mirror
    parent: upload-git-mirror
    description: Mirrors airship/deckhand to airshipit/deckhand
    vars:
      git_mirror_repository: airshipit/deckhand
    secrets:
      - name: git_mirror_credentials
        secret: deckhand-airshipit-github-ed25519-secret-2026-01-13
        pass-to-parent: true

- secret:
    name: deckhand-airshipit-github-ed25519-secret-2026-01-13
    data:
      user: git
      host: github.com
      host_key: github.com ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIOMqqnkVzrm0SdG6UOoqKLsabgH5C9okWi0dh2l9GKJl
      ssh_key: !encrypted/pkcs1-oaep
        - Ofb35I3j/KwuI9unTIn9VfAxBjPqj/BH5nTE3gfd8wdDfsIKF2HuAgifCJYCWX4W2syWk
          SLUXyuFN1FtuxLaL1AiTCF1CapaakM+Zst9OKeTrPmKME9AWISpJ93ozHBohchmbL5zjc
          dZcRt90jdWpIptYOJtB8ZyXMaqSlnn24rnbGzUDIb/AdqlPBDrNW5NsM4pddPLGQcYsua
          uDiMcTp/OkM66T5H20VSr/p0QwnHsoyxJdT9F37YokMQX9Ouir/3Np7DHYL0I86GjQ0Wd
          G/nhwEQRtAhG3K+PKEeDJLTJRNKl0PqRI0Nc5xXaYtbqDh8Kvxfue+PlAWm0j91Pw58NJ
          zJDBv2EWlnFOMvh131NM2buCYQGB51DawrNJKuGoXyvNg9dwKwpqZY3LWMShYEJdONyP6
          YaAk5f/qE0J0BelmJJITabspOI7IbCWrwdSXa4TlgnBje1CJya3u+mK8ebI3NPqDhtmLC
          quhAn821OqZEyPNyIOk8o7ZYCU7fG5bX/VqbJQutJsWL/BgVcq4O2ANKQvIDkVND4iZN6
          50uxcKhumr8sd4C2yf2YrEw0bzG+qrI4hX/CFWxxBkSemlnx4//5b6jozhN8x3HJC4FT9
          dKYm1J5KIwyqyRubPPGuq0DpG9l7Fbofptaal1OkLiMGPRnmPyIDBKfTRR9if8=
